---
- name: Configure nginx web server
  hosts: all
  become: true
  tasks:
  - name: install nginx and update cache
    yum:
      name: nginx
      state: present
      update_cache: yes

  - name: install openssl
    yum:
      name: openssl
      state: present
  
  - name: start nginx server
    service:
      name: nginx
      state: started
      enabled: true
  
- name: Configure SSL certificates
  hosts: all
  become: true
  tasks:
  - name: Create SSL private directory
    file:
      path: /etc/ssl/private
      state: directory
      mode: '0700'

  - name: Create SSL certs directory
    file:
      path: /etc/ssl/certs
      state: directory
      mode: '0755'

  - name: Get IMDSv2 token
    uri:
      url: "http://169.254.169.254/latest/api/token"
      method: PUT
      headers:
        X-aws-ec2-metadata-token-ttl-seconds: "3600"
      return_content: yes
    register: imdsv2_token

  - name: Get current public IP
    uri:
      url: "http://169.254.169.254/latest/meta-data/public-ipv4"
      headers:
        X-aws-ec2-metadata-token: "{{ imdsv2_token.content }}"
      return_content: yes
    register: public_ip

  - name: Show current public IP
    debug:
      msg: "Public IP: {{ public_ip.content }}"

  - name: Save public IP as fact
    set_fact:
      server_public_ip: "{{ public_ip.content }}"

  - name: Generate self-signed SSL certificate
    command: >
      openssl req -x509 -nodes -days 365
      -newkey rsa:2048
      -keyout /etc/ssl/private/selfsigned.key 
      -out /etc/ssl/certs/selfsigned.crt 
      -subj "/CN={{ public_ip.content }}" 
      -addext "subjectAltName=IP:{{ public_ip.content }}" 
      -addext "basicConstraints=CA:FALSE"
      -addext "keyUsage=digitalSignature,keyEncipherment"
      -addext "extendedKeyUsage=serverAuth"
    args:
      creates: /etc/ssl/certs/selfsigned.crt

- name: Deploy Nginx website and configuration files
  hosts: all
  become: true
  tasks:
    - name: install php-fpm and php-curl
      yum:
        name:
          - php-fpm
          - php-curl
        state: present

    - name: Copy website files
      copy:
        src: files/index.php
        dest: /usr/share/nginx/html/index.php
        owner: nginx
        group: nginx
        mode: '0644'  

    - name: Copy nginx.conf template
      template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'

    - name: Restart nginx
      service:
        name: nginx
        state: restarted
  
    - name: Start and enable php-fpm
      service:
        name: php-fpm
        state: started
        enabled: true
